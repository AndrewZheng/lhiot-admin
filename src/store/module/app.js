import {
  getBreadCrumbList,
  setTagNavListInLocalstorage,
  getTagNavListFromLocalstorage,
  getMenuByRouter,
  getHomeRoute,
  getNextRoute,
  routeHasExist,
  routeEqual,
  getRouteTitleHandled
} from '@/libs/util';
import beforeClose from '@/router/before-close';
import router from '@/router';
import routers from '@/router/routers';

const closePage = (state, route) => {
  const nextRoute = getNextRoute(state.tagNavList, route);
  state.tagNavList = state.tagNavList.filter(item => {
    return !routeEqual(item, route);
  });
  router.push(nextRoute);
};

const state= {
  breadCrumbList: [],
  tagNavList: [],
  homeRoute: getHomeRoute(routers),
  local: ''
};

const getters={
  menuList: (state, getters, rootState) => {
    const menuData=getMenuByRouter(rootState.user.actualRouter);
    console.log('menuData: ', menuData);
    return menuData;
  }
};

const mutations= {
  setBreadCrumb (state, route) {
    state.breadCrumbList = getBreadCrumbList(route, state.homeRoute);
  },
  setTagNavList (state, list) {
    if (list) {
      state.tagNavList = [...list];
      setTagNavListInLocalstorage([...list]);
    } else state.tagNavList = getTagNavListFromLocalstorage();
  },
  closeTag (state, route) {
    let tag = state.tagNavList.filter(item => routeEqual(item, route));
    route = tag[0] ? tag[0] : null;
    if (!route) return;
    if (route.meta && route.meta.beforeCloseName && route.meta.beforeCloseName in beforeClose) {
      new Promise(beforeClose[route.meta.beforeCloseName]).then(close => {
        if (close) {
          closePage(state, route);
        }
      });
    } else {
      closePage(state, route);
    }
  },
  addTag (state, { route, type = 'unshift' }) {
    let router = getRouteTitleHandled(route);
    if (!routeHasExist(state.tagNavList, router)) {
      if (type === 'push') state.tagNavList.push(router);
      else {
        if (router.name === 'home') state.tagNavList.unshift(router);
        else state.tagNavList.splice(1, 0, router);
      }
      setTagNavListInLocalstorage([...state.tagNavList]);
    }
    setTagNavListInLocalstorage([...state.tagNavList]);
  },
  setLocal (state, lang) {
    state.local = lang;
  }
};

const actions={

};

export default {
  state,
  getters,
  mutations,
  actions
};
